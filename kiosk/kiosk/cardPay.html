<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>kiosk</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="../css/all/font.css" rel="stylesheet">
    <link href="../css/all/all.css" rel="stylesheet">
    <link href="../css/all/orderMenu.css" rel="stylesheet">

    <script rel="javascript" type="text/javascript" src="../js/jquery-3.6.0.min.js"></script>
    <script rel="javascript" type="text/javascript" src="../js/all/all.js"></script>
    <script rel="javascript" type="text/javascript" src="../js/all/payCard.js"></script>
    <script rel="javascript" type="text/javascript" src="../js/all/payMoney.js"></script>
    <script rel="javascript" type="text/javascript" src="../js/all/printer/bxlcommon.js"></script>
    <script rel="javascript" type="text/javascript" src="../js/all/printer/bxlpos.js"></script>

    <!--    websocket-->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.js"></script>

    <script type="text/javascript">

        var cardStompClient = null;
        var cardMenuList;
        var cardPlaceStatus;
        var cardTotalPrice;
        var cardSendData = null;

        var sosoServerStatus = true;

        $(document).ready(function () {

            var audio = new Audio('../voice/카드를 꽂아주세요.wav');
            audio.play();

            var moneySocket = new SockJS('https://soso-kitchen.com/user/websocket');
            // var moneySocket = new SockJS('http://127.0.0.1:8081/user/websocket');

            cardStompClient = Stomp.over(moneySocket);

            sosoServerStatus = cardStompClient.connected;

            if (localStorage.getItem('menuList')) {
                cardMenuList = JSON.parse(localStorage.getItem("menuList"));
            }
            if (localStorage.getItem('placeStatus')) {
                cardPlaceStatus = localStorage.getItem("placeStatus");
            }
            if (localStorage.getItem('totalPrice')) {
                cardTotalPrice = localStorage.getItem("totalPrice");
            }

            setTimeout(function () {
                cardStompClient.send("/order/kiosk", {}, JSON.stringify({ //열려있나 체크
                    "check": "kiosk"
                }));
            }, 2000);


            cardStompClient.connect({}, function (frame) { //열려있나 체크

                sosoServerStatus = cardStompClient.connected;

                cardStompClient.subscribe('/sendAdminMessage/kiosk/order', function (greeting) {

                    var data = JSON.parse(greeting.body).message;

                    if (data == "noStart") {
                        voice("키오스크를 실행 시켜 주세요");
                        falseCardPayData(cardSendData);
                        payErrorModal("소소한 부엌에서 키오스크를 시작해주세요.");
                    } else if (data == "start") { //시작함
                        saveCardOrder(cardMenuList, cardPlaceStatus, cardTotalPrice);
                    }
                    if (data == "orderAfterNoStart") {
                        voice("키오스크를 실행 시켜 주세요");
                        falseCardPayData(cardSendData);
                        payErrorModal("키오스크를 실행 시켜주세요.");
                    }

                    if (data == "error") {
                        voice("관리자에게 문의해주세요");
                        falseCardPayData(cardSendData);
                        payErrorModal("데이터 저장 에러 (관리자에게 문의해주세요) ");
                    }

                });

            });

            setTimeout(function () {
                if (sosoServerStatus == false) { //서버 닫혀있음.
                    voice("서버 실행을 위해 관리자에게 문의 해주세요");
                    payErrorModal("소소한 부엌 서버가 닫혀있습니다. (관리자에게 문의 해주세요)");
                }
            }, 3000);

        });

        function falseCardPayData(data) {

            $.ajax({
                anyne: true,
                type: "POST",
                contentType: 'application/json',
                url: "http://localhost:8080/kiosk/card/fail/pay",
                dataType: "json",
                data: JSON.stringify(data),
                success: function (data) {

                }
            });
        }

    </script>
</head>
<body oncontextmenu='return false' onselectstart='return false' ondragstart='return false'> <!--우클릭 드래그 등등 방지-->

<!--결제 성공 모달-->
<div class="O-modal-back" id="successPay" style="z-index: 10">
    <div class="O-modal" style="width: 40%; height: 50%">
        <div class="O-modal-content">
            <div class="O-modal-header">
                <div class="O-modal-close-Btn">
                    <div class="O-close O-close3" id="successPayModal" onclick="successPayModalClose()"></div>
                </div>
                <div class="O-modal-top">
                    <!--                    <div class="O-modal-top-title M-font" id="deleteTop">-->
                    <!--                        <p></p>-->
                    <!--                    </div>-->
                </div>
            </div>
            <div class="O-modal-category-bar">
            </div>
            <div class="O-modal-side-order" style="height: 40%;text-align: center;" id="success-pay-modal-Body">
                <small style="font-size: 30px;">주문이 완료 되었습니다.</small><br>
                <small style="font-size: 30px;">번호표를 확인해주세요.</small><br>
                <small style="font-size: 30px;" id="successPayTime">10</small>
            </div>
            <div class="O-modal-side-footer M-flex-j-center" style="margin-top: 30px;height: 15%;">
                <div class="O-receipt-modal-btn" onclick="successPayModalClose()"
                     style="width: 35%; background-color: #d56161;">
                    <p class="M-font O-font-middle-size">닫기</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!--결제 실패 모달-->
<div class="O-modal-back" id="failPay" style="z-index: 10">
    <div class="O-modal" style="width: 40%; height: 50%">
        <div class="O-modal-content">
            <div class="O-modal-header">
                <div class="O-modal-close-Btn">
                    <div class="O-close O-close3" id="successPayModal" onclick="successPayModalClose()"></div>
                </div>
                <div class="O-modal-top">
                    <!--                    <div class="O-modal-top-title M-font" id="deleteTop">-->
                    <!--                        <p></p>-->
                    <!--                    </div>-->
                </div>
            </div>
            <div class="O-modal-category-bar">
            </div>
            <div class="O-modal-side-order" style="height: 40%;text-align: center;" id="fail-pay-modal-Body">
                <!--                <small style="font-size: 30px;">주문에 실패하였습니다.</small><br>-->
                <!--                <small style="font-size: 30px;">결제가 진행되었을 시</small><br>-->
                <!--                <small style="font-size: 30px;">관리자에게 문의 바랍니다.</small>-->
            </div>
            <div class="O-modal-side-footer M-flex-j-center" style="margin-top: 30px;height: 15%;">
                <div class="O-receipt-modal-btn" onclick="successPayModalClose()"
                     style="width: 35%; background-color: #d56161;">
                    <p class="M-font O-font-middle-size">닫기</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!--영수증 모달-->
<div class="O-modal-back" id="receiptModal">
    <div class="O-modal" style="width: 40%; height: 35%">
        <div class="O-modal-content">
            <div class="O-modal-header">
                <div class="O-modal-close-Btn">
                    <div class="O-close O-close3" id="receiptModalCloseBtn" onclick="receiptModalClose()"></div>
                </div>
                <div class="O-modal-top">
                    <!--                    <div class="O-modal-top-title M-font" id="deleteTop">-->
                    <!--                        <p></p>-->
                    <!--                    </div>-->
                </div>
            </div>
            <div class="O-modal-category-bar">
            </div>
            <div class="O-modal-side-order" style="height: 40%;text-align: center;" id="delete-modal-Body">
                <small style="font-size: 20px;">영수증을 출력하시겠습니까?</small>
            </div>
            <div class="O-modal-side-footer M-flex-j-center" id="">
                <div class="O-receipt-modal-btn" onclick="checkReceipt(true)"
                     style="width: 35%; background-color: #e9e9e9;">
                    <p class="M-font O-font-middle-size">네</p>
                </div>
                <div class="O-receipt-modal-btn" onclick="checkReceipt(false)"
                     style="width: 35%; margin-left: 30px; background-color: #e9e9e9;">
                    <p class="M-font O-font-middle-size">아니요</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container" style="display: flex;
    justify-content: center;
    align-items: center;">
    <div class="card-gif">
        <img src="./../img/ICInsert.gif">
    </div>
    <!--    <div class="cardPay-cancel-Btn M-font O-font-menu.js-size">-->
    <!--        <p onclick="location.href='/'">취소하기</p>-->
    <!--    </div>-->
</div>
</body>
</html>